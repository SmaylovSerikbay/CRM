# Исправление ошибки 502 при деплое

## Проблема

При выполнении `make deploy-all` на проде:
1. Скрипт спрашивает: "Сайт работает нормально? (y/n)"
2. При нажатии "y" сайт падает с ошибкой 502
3. Если не нажимать "y", все работает нормально

## Причина

Ошибка была в логике скрипта `deploy-blue-green.sh` в функции `auto_deploy()`:

```bash
# БЫЛО (неправильно):
set_active_color "$inactive"  # Переключаем активный цвет
sleep 30
docker compose down --profile "$active"  # Останавливаем НОВОЕ окружение!
```

После переключения `set_active_color "$inactive")`, переменная `$active` уже указывала на НОВОЕ окружение, а скрипт останавливал его вместо старого!

## Решение

Исправлена логика в `deploy-blue-green.sh`:

```bash
# СТАЛО (правильно):
local old_environment="$active"  # Сохраняем старое окружение
set_active_color "$inactive"     # Переключаем активный цвет
sleep 30
docker compose down --profile "$old_environment"  # Останавливаем СТАРОЕ окружение
```

Теперь скрипт:
1. Сохраняет старое окружение в переменную `old_environment`
2. Переключает активный цвет
3. Останавливает именно старое окружение

## Проверка Makefile

Проверены все команды деплоя - дублей не обнаружено. Все команды определены корректно:

- `make deploy-all` - Git pull + быстрый деплой
- `make bg-auto` - Автоматический деплой (спросит тип сборки)
- `make bg-auto-fast` - Быстрый деплой с кэшем
- `make bg-auto-full` - Полный деплой без кэша
- `make hot` - Hot deploy backend
- `make hot-pull` - Git pull + hot deploy

## Рекомендации

1. **Для обычных обновлений кода**: `make deploy-all` (~2-3 мин)
2. **Для обновления только backend**: `make hot-pull` (~10 сек)
3. **При изменении зависимостей**: `make bg-auto-full` (~10-15 мин)

## Что делать если сайт упал

Если после деплоя сайт не работает:

1. Проверьте статус контейнеров:
   ```bash
   make bg-status
   ```

2. Проверьте логи:
   ```bash
   docker compose -f docker-compose.blue-green.yml logs -f
   ```

3. Откатитесь к предыдущей версии:
   ```bash
   make bg-rollback
   ```

4. Или вручную переключите порты в Nginx Proxy Manager обратно

## Автоматическое переключение NPM

Скрипт пытается автоматически переключить порты в Nginx Proxy Manager через API.

Если автопереключение не работает:
- Проверьте переменные в `.env.prod`: `NPM_HOST`, `NPM_EMAIL`, `NPM_PASSWORD`
- Убедитесь, что NPM API доступен
- Переключите порты вручную в интерфейсе NPM
