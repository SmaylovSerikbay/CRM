# Авторизация через пароль

## Обзор

В систему добавлена возможность авторизации через обычный пароль в дополнение к существующей авторизации через OTP (код из WhatsApp).

## Возможности

### 1. Два способа входа

Пользователи теперь могут выбрать один из двух способов авторизации:
- **Код через WhatsApp** (OTP) - существующий метод
- **Пароль** - новый метод для быстрого входа

### 2. Установка пароля

Пользователи могут установить пароль в настройках профиля:
1. Перейдите в **Настройки** → **Безопасность**
2. Заполните форму установки пароля:
   - Новый пароль (минимум 6 символов)
   - Подтверждение пароля
3. Нажмите "Установить пароль"

### 3. Изменение пароля

Если пароль уже установлен, вы можете его изменить:
1. Перейдите в **Настройки** → **Безопасность**
2. Введите текущий пароль
3. Введите новый пароль и подтверждение
4. Нажмите "Изменить пароль"

## API Endpoints

### 1. Авторизация через пароль

```
POST /api/users/login_with_password/
```

**Параметры:**
```json
{
  "phone": "+7 777 123 4567",
  "password": "your_password"
}
```

**Ответ:**
```json
{
  "id": "1",
  "phone": "+7 777 123 4567",
  "role": "clinic",
  "clinic_role": "manager",
  "registration_completed": true,
  "registration_data": {...},
  "created_at": "2025-12-04T10:00:00Z",
  "last_login_at": "2025-12-04T15:00:00Z"
}
```

### 2. Установка/изменение пароля

```
POST /api/users/set_password/
```

**Параметры (установка нового пароля):**
```json
{
  "phone": "+7 777 123 4567",
  "new_password": "new_secure_password"
}
```

**Параметры (изменение существующего пароля):**
```json
{
  "phone": "+7 777 123 4567",
  "old_password": "current_password",
  "new_password": "new_secure_password"
}
```

**Ответ:**
```json
{
  "message": "Password set successfully"
}
```

### 3. Регистрация с паролем (опционально)

При завершении регистрации можно сразу установить пароль:

```
POST /api/users/complete_registration/
```

**Параметры:**
```json
{
  "phone": "+7 777 123 4567",
  "role": "clinic",
  "clinic_role": "manager",
  "registration_data": {...},
  "password": "optional_password"
}
```

## Безопасность

- Пароли хешируются с использованием Django's `make_password` (PBKDF2)
- Минимальная длина пароля: 6 символов
- При изменении пароля требуется ввод старого пароля
- Пароли никогда не передаются в открытом виде в ответах API

## Использование на фронтенде

### Компоненты

1. **Страница авторизации** (`frontend/app/auth/page.tsx`)
   - Переключатель между OTP и паролем
   - Форма входа через пароль
   - Возможность вернуться к OTP

2. **Форма установки пароля** (`frontend/components/auth/SetPasswordForm.tsx`)
   - Установка нового пароля
   - Изменение существующего пароля
   - Валидация и обработка ошибок

3. **Страница настроек** (`frontend/app/dashboard/settings/page.tsx`)
   - Раздел "Безопасность" с формой установки пароля

### API клиент

```typescript
// Вход через пароль
await userStore.loginWithPassword(phone, password);

// Установка пароля
await userStore.setPassword(phone, newPassword);

// Изменение пароля
await userStore.setPassword(phone, newPassword, oldPassword);
```

## Миграция существующих пользователей

Существующие пользователи могут продолжать использовать OTP авторизацию. Для использования авторизации через пароль им нужно:

1. Войти через OTP (как обычно)
2. Перейти в Настройки → Безопасность
3. Установить пароль
4. При следующем входе можно использовать пароль

## Рекомендации

- Используйте надежные пароли (минимум 8 символов, включая буквы, цифры и спецсимволы)
- Регулярно меняйте пароль
- Не используйте один и тот же пароль для разных сервисов
- OTP авторизация остается доступной в любое время как альтернатива

## Тестирование

### Тестирование через Docker

1. Убедитесь, что контейнеры запущены:
```bash
docker ps
```

2. Перезапустите контейнеры для применения изменений:
```bash
docker restart crm-backend-dev
docker restart crm-frontend-dev
```

3. Проверьте логи:
```bash
docker logs crm-backend-dev --tail 50
docker logs crm-frontend-dev --tail 50
```

### Ручное тестирование

1. Откройте http://localhost:3001/auth
2. Выберите "Пароль" вместо "Код через WhatsApp"
3. Введите номер телефона и пароль
4. Проверьте вход в систему

### API тестирование

```bash
# Установка пароля
curl -X POST http://localhost:8001/api/users/set_password/ \
  -H "Content-Type: application/json" \
  -d '{"phone": "+7 777 123 4567", "new_password": "test123456"}'

# Вход через пароль
curl -X POST http://localhost:8001/api/users/login_with_password/ \
  -H "Content-Type: application/json" \
  -d '{"phone": "+7 777 123 4567", "password": "test123456"}'
```

## Troubleshooting

### Ошибка "Password not set for this user"
- Пользователь еще не установил пароль
- Решение: используйте OTP авторизацию или установите пароль в настройках

### Ошибка "Invalid password"
- Неверный пароль
- Решение: проверьте правильность ввода или используйте OTP для восстановления доступа

### Ошибка "Password must be at least 6 characters long"
- Пароль слишком короткий
- Решение: используйте пароль длиной минимум 6 символов
