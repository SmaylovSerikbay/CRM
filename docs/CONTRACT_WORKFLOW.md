# Система согласования договоров с журналированием

## Обзор

Реализована полноценная система согласования договоров между клиникой и работодателем с возможностью редактирования, отклонения и полным журналированием всех действий.

## Возможности

### Для клиники

1. **Создание договора**
   - Указание БИН организации работодателя
   - Поиск существующего работодателя по БИН
   - Заполнение всех данных договора
   - Автоматическая отправка уведомления работодателю

2. **Редактирование договора**
   - Доступно только для договоров в статусах `draft` (черновик) или `rejected` (отклонен)
   - Можно изменить: номер, дату, сумму, количество людей, дату исполнения, примечания
   - Все изменения записываются в историю

3. **Отправка на согласование**
   - Первичная отправка из статуса `draft`
   - Повторная отправка после доработки из статуса `rejected`
   - Возможность добавить комментарий при повторной отправке

4. **Просмотр истории**
   - Полная история всех действий с договором
   - Информация о том, кто и когда выполнил действие
   - Детали изменений полей
   - Комментарии и причины отклонения

### Для работодателя

1. **Просмотр договоров**
   - Список всех договоров от клиник
   - Детальная информация по каждому договору

2. **Согласование договора**
   - Подписание договора одной кнопкой
   - Автоматическое изменение статуса

3. **Отклонение договора**
   - Обязательное указание причины отклонения
   - Причина сохраняется в истории
   - Клиника может доработать и отправить повторно

4. **Просмотр истории**
   - Полная история изменений договора
   - Все комментарии и причины действий

## Статусы договора

1. **draft** (Черновик) - начальный статус, договор можно редактировать
2. **pending_approval** (Ожидает согласования) - отправлен работодателю
3. **rejected** (Отклонен) - работодатель отклонил с указанием причины
4. **approved** (Согласован) - обе стороны согласовали
5. **sent** (Отправлен) - договор отправлен
6. **executed** (Исполнен) - договор исполнен
7. **cancelled** (Отменен) - договор отменен

## Журналирование

Все действия с договором записываются в таблицу `ContractHistory`:

### Типы действий

- **created** - Договор создан
- **updated** - Договор обновлен (с деталями изменений)
- **sent_for_approval** - Отправлен на согласование
- **resent_for_approval** - Повторно отправлен после доработки
- **approved** - Согласован
- **rejected** - Отклонен (с причиной)
- **cancelled** - Отменен
- **executed** - Исполнен

### Информация в истории

- Действие и его описание
- Пользователь (имя и роль)
- Старый и новый статус
- Комментарий/причина
- Детали изменений полей (для действия "updated")
- Дата и время

## Workflow (Рабочий процесс)

### Сценарий 1: Успешное согласование

1. Клиника создает договор → статус `draft`
2. Клиника отправляет на согласование → статус `pending_approval`
3. Работодатель согласовывает → статус `approved`
4. Договор исполняется → статус `executed`

### Сценарий 2: Отклонение и доработка

1. Клиника создает договор → статус `draft`
2. Клиника отправляет на согласование → статус `pending_approval`
3. Работодатель отклоняет с причиной "Неверная сумма" → статус `rejected`
4. Клиника редактирует договор (исправляет сумму) → статус `rejected`
5. Клиника повторно отправляет с комментарием "Исправлена сумма" → статус `pending_approval`
6. Работодатель согласовывает → статус `approved`
7. Договор исполняется → статус `executed`

## API Endpoints

### Для клиники

- `POST /contracts/` - Создание договора
- `PATCH /contracts/{id}/update_contract/` - Обновление договора
- `POST /contracts/{id}/resend_for_approval/` - Повторная отправка
- `GET /contracts/{id}/history/` - История изменений

### Для работодателя

- `POST /contracts/{id}/approve/` - Согласование договора
- `POST /contracts/{id}/reject/` - Отклонение договора
- `GET /contracts/{id}/history/` - История изменений

## Ограничения

1. **Редактирование**: Только клиника может редактировать договор
2. **Статусы для редактирования**: Только `draft` или `rejected`
3. **Отклонение**: Только работодатель может отклонить договор
4. **Обязательная причина**: При отклонении обязательно указать причину
5. **История**: Все действия необратимы и сохраняются в истории

## Уведомления

- При создании договора работодатель получает WhatsApp уведомление
- При повторной отправке работодатель получает новое уведомление
- В уведомлении указывается ссылка для перехода к договору

## Интерфейс

### Клиника (`/dashboard/clinic/contracts`)

- Список всех договоров
- Кнопка "Создать договор"
- Для договоров в статусе `draft` или `rejected`:
  - Кнопка "Редактировать"
  - Кнопка "Отправить на согласование" / "Отправить повторно"
- Кнопка "История" для каждого договора
- Отображение истории с деталями изменений

### Работодатель (`/dashboard/employer/contracts`)

- Список всех договоров
- Для договоров в статусе `pending_approval`:
  - Кнопка "Подписать"
  - Кнопка "Отклонить" с формой для указания причины
- Кнопка "История" для каждого договора
- Отображение истории с комментариями

## База данных

### Таблица Contract

Добавлен новый статус:
- `rejected` - Отклонен

### Таблица ContractHistory (новая)

```python
- contract: ForeignKey(Contract)
- action: CharField (тип действия)
- user: ForeignKey(User)
- user_role: CharField
- user_name: CharField
- comment: TextField (комментарий/причина)
- old_status: CharField
- new_status: CharField
- changes: JSONField (детали изменений)
- created_at: DateTimeField
```

## Миграция

Создана миграция `0012_alter_contract_status_contracthistory.py`:
- Добавлен статус `rejected` в Contract
- Создана модель ContractHistory

Для применения:
```bash
docker-compose -f docker-compose.dev.yml exec backend python manage.py migrate
```

## Тестирование

1. Создайте договор от имени клиники
2. Отправьте на согласование
3. От имени работодателя отклоните с причиной
4. Просмотрите историю - должна быть запись об отклонении
5. От имени клиники отредактируйте договор
6. Просмотрите историю - должна быть запись об изменениях
7. Отправьте повторно с комментарием
8. От имени работодателя согласуйте
9. Просмотрите полную историю всех действий
