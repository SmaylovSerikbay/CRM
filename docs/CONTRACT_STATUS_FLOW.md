# Жизненный цикл договора

## Обзор

Договор между клиникой и работодателем проходит через несколько статусов от создания до полного исполнения.

## Статусы договора

### 1. Черновик (draft)
- Начальный статус при создании договора клиникой
- Договор еще не отправлен на согласование

### 2. Ожидает согласования (pending_approval)
- Договор отправлен на согласование одной из сторон
- Ожидает подписи второй стороны

### 3. Согласован (approved)
- Одна из сторон подписала договор
- Ожидает подписи второй стороны

### 4. Действует (active)
- **Обе стороны подписали договор**
- Договор вступил в силу
- Можно начинать медосмотры

### 5. В процессе исполнения (in_progress)
- Начались медосмотры сотрудников
- Договор активно исполняется

### 6. Частично исполнен (partially_executed)
- Часть сотрудников прошла медосмотр
- Есть завершенные экспертизы с вердиктом профпатолога
- Процент выполнения: 1-99%

### 7. Исполнен (executed)
- **Все сотрудники прошли медосмотр**
- Все экспертизы завершены
- Процент выполнения: 100%

### 8. Отменен (cancelled)
- Договор отменен по какой-либо причине

## Логика переходов

### Согласование договора
```
draft → pending_approval (первая подпись)
pending_approval → active (вторая подпись)
```

### Исполнение договора
```
active → in_progress (начало медосмотров)
in_progress → partially_executed (автоматически при завершении первой экспертизы)
partially_executed → executed (автоматически когда все прошли медосмотр)
```

## Автоматическое обновление статуса

Система автоматически обновляет статус договора при:

1. **Создании экспертизы с вердиктом** - проверяется прогресс исполнения договора
2. **Вызове API `/contracts/{id}/check_completion/`** - ручная проверка статуса

### Расчет прогресса

```python
completed_count = количество_сотрудников_с_завершенной_экспертизой
total_people = contract.people_count
percentage = (completed_count / total_people) * 100

if percentage == 100:
    status = 'executed'
elif percentage > 0:
    status = 'partially_executed'
```

## API методы

### Согласование договора
```
POST /api/contracts/{id}/approve/
Body: { "user_id": "..." }
```

### Начало исполнения
```
POST /api/contracts/{id}/execute/
Body: { "user_id": "..." }
```

### Проверка статуса исполнения
```
GET /api/contracts/{id}/check_completion/
Response: {
  "status": "partially_executed",
  "completed": 15,
  "total": 50,
  "percentage": 30.0,
  "message": "Завершено 15 из 50 медосмотров"
}
```

## Важные замечания

1. **Статус "исполнен" устанавливается только после завершения всех медосмотров**, а не при согласовании договора
2. Медосмотр считается завершенным, когда профпатолог вынес вердикт (создана экспертиза с `final_verdict`)
3. Система автоматически отслеживает прогресс и обновляет статус договора
4. Работодатель и клиника могут видеть прогресс исполнения договора в реальном времени
