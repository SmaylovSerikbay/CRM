# Оптимизация деплоя

## Проблема

При использовании `make bg-auto` происходит полная пересборка Docker образов с флагом `--no-cache`, что занимает 10-15 минут даже при небольших изменениях в коде.

## Решение

Теперь доступны 3 варианта деплоя:

### 1. Быстрый деплой (рекомендуется для изменений кода)

```bash
make bg-auto-fast
```

**Когда использовать:**
- Изменили код frontend/backend
- Изменили конфигурацию
- Исправили баги
- Добавили новые функции

**Время:** ~2-3 минуты

**Что происходит:**
- Использует Docker layer cache
- Пересобирает только измененные слои
- Быстро копирует новый код

### 2. Полный деплой (для изменений зависимостей)

```bash
make bg-auto-full
```

**Когда использовать:**
- Обновили package.json (npm пакеты)
- Обновили requirements.txt (Python пакеты)
- Изменили Dockerfile
- Обновили базовые образы

**Время:** ~10-15 минут

**Что происходит:**
- Игнорирует весь кэш (`--no-cache`)
- Пересобирает все слои с нуля
- Гарантирует чистую сборку

### 3. Интерактивный деплой (спросит что делать)

```bash
make bg-auto
```

**Что происходит:**
- Спросит какой тип сборки использовать
- Можно выбрать быстрый (1) или полный (2)
- По умолчанию (Enter) = быстрый

## Сравнение времени

| Тип деплоя | Время | Использование |
|------------|-------|---------------|
| Быстрый | 2-3 мин | 90% случаев |
| Полный | 10-15 мин | 10% случаев |

## Как работает кэширование

Docker кэширует каждый слой в Dockerfile:

```dockerfile
# Этот слой кэшируется если package.json не изменился
COPY package.json package-lock.json ./
RUN npm ci

# Этот слой пересобирается при изменении кода
COPY . .
RUN npm run build
```

**Быстрая сборка:**
- Если `package.json` не изменился → использует кэш для `npm ci`
- Если код изменился → пересобирает только `COPY . .` и `npm run build`

**Полная сборка:**
- Игнорирует весь кэш
- Заново скачивает все пакеты
- Пересобирает все слои

## Рекомендации

### Для ежедневной разработки

```bash
# Быстрый деплой для изменений кода
make bg-auto-fast
```

### После обновления зависимостей

```bash
# Обновили package.json или requirements.txt
make bg-auto-full
```

### При проблемах со сборкой

```bash
# Если что-то сломалось, полная пересборка может помочь
make bg-auto-full
```

## Дополнительная оптимизация

### 1. Используйте .dockerignore

Убедитесь что `.dockerignore` исключает ненужные файлы:

```
node_modules
.git
.env*
*.md
docs/
```

### 2. Многоступенчатая сборка

Frontend уже использует multi-stage build:

```dockerfile
# Стадия 1: Сборка
FROM node:20-alpine AS builder
COPY . .
RUN npm run build

# Стадия 2: Production
FROM node:20-alpine
COPY --from=builder /app/.next ./.next
```

Это уменьшает размер финального образа.

### 3. BuildKit

В `.env.prod` уже включен BuildKit:

```bash
DOCKER_BUILDKIT=1
COMPOSE_DOCKER_CLI_BUILD=1
```

Это ускоряет сборку в 2-3 раза.

## Troubleshooting

### Сборка все равно медленная

1. Проверьте что BuildKit включен:
   ```bash
   echo $DOCKER_BUILDKIT
   # Должно быть: 1
   ```

2. Очистите старые образы:
   ```bash
   docker system prune -a
   ```

3. Проверьте место на диске:
   ```bash
   df -h
   ```

### Кэш не работает

1. Убедитесь что не используете `--no-cache`
2. Проверьте что файлы не изменились (например, `.env` файлы)
3. Попробуйте полную пересборку один раз

### Ошибки после быстрой сборки

Если после быстрой сборки что-то не работает:

```bash
# Сделайте полную пересборку
make bg-auto-full
```

## Статистика

На тестовом проекте:

- **Полная сборка:** 12 минут
- **Быстрая сборка (изменен 1 файл):** 2 минуты
- **Ускорение:** 6x

## Выводы

- Используйте **быстрый деплой** для 90% случаев
- Используйте **полный деплой** только при изменении зависимостей
- Экономьте 10 минут на каждом деплое!
