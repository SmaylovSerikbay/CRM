# 🔄 Схема процесса деплоя

## Визуальная схема

```
┌─────────────────────────────────────────────────────────────────┐
│                    АВТОМАТИЧЕСКИЙ ДЕПЛОЙ                         │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐
│  Разработчик │
│  вносит      │
│  изменения   │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  Windows: deploy.bat "описание"                              │
│  Linux:   make deploy                                        │
└──────┬───────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  ШАГ 1: GIT COMMIT                                           │
│  ─────────────────────                                       │
│  • git add .                                                 │
│  • git commit -m "описание"                                  │
└──────┬───────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  ШАГ 2: GIT PUSH                                             │
│  ────────────────                                            │
│  • git push origin main                                      │
└──────┬───────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  ШАГ 3: SSH ПОДКЛЮЧЕНИЕ                                      │
│  ───────────────────────                                     │
│  • ssh root@89.207.255.13                                    │
│  • cd /root/crm-medical                                      │
└──────┬───────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  ШАГ 4: ОБНОВЛЕНИЕ КОДА                                      │
│  ───────────────────────                                     │
│  • git pull origin main                                      │
└──────┬───────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  ШАГ 5: ПЕРЕСБОРКА ОБРАЗОВ (только deploy, не deploy-quick) │
│  ────────────────────────────────────────────────────────    │
│  • docker compose -f docker-compose.yml build                │
└──────┬───────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  ШАГ 6: ПЕРЕЗАПУСК КОНТЕЙНЕРОВ                               │
│  ──────────────────────────────                              │
│  • docker compose -f docker-compose.yml up -d                │
└──────┬───────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│  ✅ ДЕПЛОЙ ЗАВЕРШЕН                                          │
│  Сайт обновлен и работает!                                   │
└──────────────────────────────────────────────────────────────┘
```

## Сравнение: Ручной vs Автоматический деплой

### ❌ Ручной деплой (старый способ)

```bash
# 1. Коммит
git add .
git commit -m "описание"
git push origin main

# 2. Подключение к серверу
ssh root@89.207.255.13

# 3. На сервере
cd /root/crm-medical
git pull origin main
docker compose -f docker-compose.yml build
docker compose -f docker-compose.yml up -d
exit

# Итого: ~10 команд, 5-10 минут
```

### ✅ Автоматический деплой (новый способ)

```cmd
deploy.bat "описание"

# Итого: 1 команда, 30 секунд!
```

## Типы деплоя

### 1. Полный деплой (deploy.bat / make deploy)

```
Локальная машина          →    Git репозиторий    →    Prod сервер
─────────────────              ─────────────────        ────────────
Изменения в коде               Commit + Push            git pull
                                                        docker build
                                                        docker up -d

Время: ~3-5 минут
Когда: Изменения в зависимостях, Dockerfile, новые пакеты
```

### 2. Быстрый деплой (deploy-quick.bat / make deploy-quick)

```
Локальная машина          →    Git репозиторий    →    Prod сервер
─────────────────              ─────────────────        ────────────
Изменения в коде               Commit + Push            git pull
                                                        docker restart

Время: ~30 секунд
Когда: Только изменения в коде, без новых зависимостей
```

## Workflow разработки

```
┌─────────────────────────────────────────────────────────────┐
│                    ЦИКЛ РАЗРАБОТКИ                          │
└─────────────────────────────────────────────────────────────┘

1. РАЗРАБОТКА
   ├─ Запустить локально: make dev
   ├─ Внести изменения в код
   ├─ Протестировать локально
   └─ Убедиться что всё работает
      │
      ▼
2. ДЕПЛОЙ
   ├─ deploy.bat "описание"
   └─ Подождать завершения
      │
      ▼
3. ПРОВЕРКА
   ├─ Открыть сайт
   ├─ Проверить функционал
   └─ Если проблемы → server-logs.bat
      │
      ▼
4. МОНИТОРИНГ
   ├─ Проверить логи
   ├─ Проверить статус контейнеров
   └─ Всё работает? → Готово! ✅
```

## Архитектура деплоя

```
┌──────────────────────────────────────────────────────────────┐
│                    ЛОКАЛЬНАЯ МАШИНА                          │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  Код проекта                                           │  │
│  │  ├─ frontend/                                          │  │
│  │  ├─ backend/                                           │  │
│  │  └─ docker-compose.yml                                 │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  Скрипты деплоя                                        │  │
│  │  ├─ deploy.bat                                         │  │
│  │  ├─ deploy-quick.bat                                   │  │
│  │  └─ setup-ssh.bat                                      │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────┬───────────────────────────────────────────┘
                   │
                   │ SSH (port 22)
                   │ Аутентификация: SSH ключ
                   │
                   ▼
┌──────────────────────────────────────────────────────────────┐
│                    PROD СЕРВЕР (VDS)                         │
│  IP: 89.207.255.13                                           │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  /root/crm-medical/                                    │  │
│  │  ├─ frontend/                                          │  │
│  │  ├─ backend/                                           │  │
│  │  ├─ docker-compose.yml                                 │  │
│  │  └─ .env                                               │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  Docker контейнеры                                     │  │
│  │  ├─ frontend (Next.js) → :3000                         │  │
│  │  ├─ backend (Django)   → :8000                         │  │
│  │  └─ postgres (DB)      → :5432                         │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

## Безопасность деплоя

```
┌──────────────────────────────────────────────────────────────┐
│                    БЕЗОПАСНОЕ ПОДКЛЮЧЕНИЕ                    │
└──────────────────────────────────────────────────────────────┘

1. ГЕНЕРАЦИЯ SSH КЛЮЧА
   ┌─────────────────────────────────────────┐
   │  ssh-keygen -t rsa -b 4096              │
   │  Создает пару ключей:                   │
   │  • id_rsa (приватный) - НЕ ПЕРЕДАВАТЬ! │
   │  • id_rsa.pub (публичный) - на сервер  │
   └─────────────────────────────────────────┘
                    │
                    ▼
2. КОПИРОВАНИЕ НА СЕРВЕР
   ┌─────────────────────────────────────────┐
   │  ssh-copy-id root@89.207.255.13         │
   │  Публичный ключ → ~/.ssh/authorized_keys│
   └─────────────────────────────────────────┘
                    │
                    ▼
3. ПОДКЛЮЧЕНИЕ БЕЗ ПАРОЛЯ
   ┌─────────────────────────────────────────┐
   │  ssh root@89.207.255.13                 │
   │  Аутентификация через приватный ключ    │
   │  Пароль больше не нужен! ✅             │
   └─────────────────────────────────────────┘
```

## Обработка ошибок

```
┌──────────────────────────────────────────────────────────────┐
│                    ОБРАБОТКА ОШИБОК                          │
└──────────────────────────────────────────────────────────────┘

deploy.bat
    │
    ├─ git add . ──────────────┐
    │                          │ Ошибка?
    ├─ git commit ─────────────┤ → Показать сообщение
    │                          │   Продолжить
    ├─ git push ───────────────┤
    │                          │ Ошибка?
    ├─ ssh + git pull ─────────┤ → Показать сообщение
    │                          │   Остановить деплой
    ├─ docker build ───────────┤
    │                          │ Ошибка?
    └─ docker up -d ───────────┘ → Показать логи
                                   Остановить деплой
```

## Мониторинг после деплоя

```
┌──────────────────────────────────────────────────────────────┐
│                    ПРОВЕРКА ПОСЛЕ ДЕПЛОЯ                     │
└──────────────────────────────────────────────────────────────┘

1. АВТОМАТИЧЕСКАЯ ПРОВЕРКА
   ├─ Контейнеры запустились?
   ├─ Порты открыты?
   └─ Нет критических ошибок в логах?

2. РУЧНАЯ ПРОВЕРКА
   ├─ Открыть сайт в браузере
   ├─ Проверить основной функционал
   └─ Проверить API endpoints

3. МОНИТОРИНГ
   ├─ server-logs.bat → Логи в реальном времени
   ├─ docker compose ps → Статус контейнеров
   └─ docker stats → Использование ресурсов
```

## Откат изменений

```
┌──────────────────────────────────────────────────────────────┐
│                    ОТКАТ К ПРЕДЫДУЩЕЙ ВЕРСИИ                 │
└──────────────────────────────────────────────────────────────┘

Если деплой сломал прод:

1. ЛОКАЛЬНО
   git log                    # Найти хороший коммит
   git reset --hard HASH      # Откатиться
   git push -f origin main    # Принудительный push

2. НА СЕРВЕРЕ
   deploy.bat "Откат"         # Автоматически обновит

3. АЛЬТЕРНАТИВА (на сервере напрямую)
   ssh root@89.207.255.13
   cd /root/crm-medical
   git reset --hard HASH
   docker compose restart
```

## Оптимизация времени деплоя

```
┌──────────────────────────────────────────────────────────────┐
│                    ВРЕМЯ ДЕПЛОЯ                              │
└──────────────────────────────────────────────────────────────┘

deploy.bat (полный)
├─ git commit + push      ~10 сек
├─ ssh подключение        ~2 сек
├─ git pull               ~5 сек
├─ docker build           ~2-3 мин  ← Самое долгое
└─ docker up -d           ~10 сек
   ИТОГО: ~3-5 минут

deploy-quick.bat (быстрый)
├─ git commit + push      ~10 сек
├─ ssh подключение        ~2 сек
├─ git pull               ~5 сек
└─ docker restart         ~10 сек
   ИТОГО: ~30 секунд  ← В 6 раз быстрее!

Используйте deploy-quick когда:
✅ Только изменения в коде
✅ Нет новых зависимостей
✅ Не менялся Dockerfile
```

## Резюме

### Преимущества автоматического деплоя

✅ **Скорость**: 1 команда вместо 10
✅ **Надежность**: Меньше ошибок
✅ **Простота**: Не нужно помнить команды
✅ **Безопасность**: SSH ключи
✅ **Удобство**: Работает на Windows и Linux

### Когда использовать

- 🚀 **deploy.bat** - Новые зависимости, изменения в Dockerfile
- ⚡ **deploy-quick.bat** - Только изменения в коде
- 📊 **server-logs.bat** - Проверка после деплоя
- 🔌 **server-connect.bat** - Ручная настройка на сервере

---

📖 **См. также:**
- [DEPLOY.md](../DEPLOY.md) - Быстрый старт
- [DEPLOY_CHEATSHEET.md](../DEPLOY_CHEATSHEET.md) - Шпаргалка
- [DEPLOY_EXAMPLES.md](./DEPLOY_EXAMPLES.md) - Примеры использования
