# Двухэтапный процесс исполнения договора

## Обзор

Реализован двухэтапный процесс исполнения договора между клиникой и работодателем:

1. **Клиника** отмечает договор как исполненный (полностью или частично)
2. **Работодатель** подтверждает или отклоняет исполнение с указанием причины

## Процесс исполнения

### Шаг 1: Клиника отмечает исполнение

Когда клиника завершает работы по договору, она:

1. Открывает список договоров
2. Находит договор со статусом "Действует" или "В процессе исполнения"
3. Нажимает кнопку **"Отметить исполнение"**
4. В модальном окне выбирает:
   - **Тип исполнения**:
     - **Полное исполнение** - все работы выполнены
     - **Частичное исполнение** - часть работ выполнена
   - **Примечания** (опционально) - детали исполнения, количество обследованных сотрудников и т.д.
5. Нажимает **"Отметить исполнение"**

После этого:
- Договор переходит в статус `executed` (полное) или `partially_executed` (частичное)
- Устанавливается поле `executed_by_clinic_at` с текущей датой
- Сохраняются `execution_type` и `execution_notes`
- Создается запись в истории договора
- Работодатель видит индикатор "Ожидает подтверждения работодателя"

### Шаг 2: Работодатель подтверждает или отклоняет

Работодатель получает договор на подтверждение и может:

#### Вариант А: Подтвердить исполнение

1. Открывает список договоров
2. Видит кнопку **"Подтвердить исполнение"**
3. Нажимает кнопку и подтверждает действие
4. Договор остается в статусе `executed` или `partially_executed`
5. Устанавливается поле `confirmed_by_employer_at`
6. Создается запись в истории
7. Клиника видит индикатор "Подтверждено работодателем"

#### Вариант Б: Отклонить исполнение

1. Открывает список договоров
2. Видит кнопку **"Отклонить исполнение"**
3. Нажимает кнопку
4. Указывает причину отклонения (обязательно)
5. Договор возвращается в статус `in_progress`
6. Сохраняется `employer_rejection_reason`
7. Создается запись в истории
8. Клиника видит индикатор "Отклонено работодателем" с причиной

## Поля базы данных

### Новые поля в модели Contract

```python
# Тип исполнения, указанный клиникой
execution_type = models.CharField(
    max_length=20, 
    null=True, 
    blank=True, 
    choices=[
        ('full', 'Полное исполнение'),
        ('partial', 'Частичное исполнение'),
    ]
)

# Дата отметки исполнения клиникой
executed_by_clinic_at = models.DateTimeField(null=True, blank=True)

# Примечания клиники при отметке исполнения
execution_notes = models.TextField(blank=True)

# Дата подтверждения работодателем
confirmed_by_employer_at = models.DateTimeField(null=True, blank=True)

# Причина отклонения работодателем
employer_rejection_reason = models.TextField(blank=True)
```

## API Endpoints

### 1. Отметка исполнения клиникой

**POST** `/api/contracts/{id}/mark_executed_by_clinic/`

**Request:**
```json
{
  "user_id": "123",
  "execution_type": "full",  // или "partial"
  "execution_notes": "Обследовано 50 сотрудников. Все медосмотры завершены."
}
```

**Response:** Обновленный объект договора

### 2. Подтверждение исполнения работодателем

**POST** `/api/contracts/{id}/confirm_execution_by_employer/`

**Request:**
```json
{
  "user_id": "456"
}
```

**Response:** Обновленный объект договора

### 3. Отклонение исполнения работодателем

**POST** `/api/contracts/{id}/reject_execution_by_employer/`

**Request:**
```json
{
  "user_id": "456",
  "rejection_reason": "Не все сотрудники прошли медосмотр. Требуется дообследование 10 человек."
}
```

**Response:** Обновленный объект договора

## Frontend API Methods

### WorkflowStoreAPI

```typescript
// Отметка исполнения клиникой
async markExecutedByClinic(
  contractId: string, 
  executionType: 'full' | 'partial', 
  executionNotes: string
): Promise<void>

// Подтверждение работодателем
async confirmExecutionByEmployer(contractId: string): Promise<void>

// Отклонение работодателем
async rejectExecutionByEmployer(
  contractId: string, 
  rejectionReason: string
): Promise<void>
```

## UI Компоненты

### Для клиники

1. **Кнопка "Отметить исполнение"** - отображается для договоров со статусом `active` или `in_progress`, которые еще не отмечены как исполненные
2. **Индикатор "Ожидает подтверждения работодателя"** - желтый бейдж, отображается после отметки исполнения
3. **Индикатор "Подтверждено работодателем"** - зеленый бейдж
4. **Индикатор "Отклонено работодателем"** - красный бейдж
5. **Модальное окно отметки исполнения** - форма с выбором типа и примечаниями

### Для работодателя

1. **Кнопка "Подтвердить исполнение"** - зеленая кнопка для подтверждения
2. **Кнопка "Отклонить исполнение"** - красная кнопка для отклонения
3. **Индикатор "Исполнение подтверждено"** - зеленый бейдж
4. **Индикатор "Исполнение отклонено"** - красный бейдж

## Статусы договора

- `active` - Действует (договор подписан обеими сторонами)
- `in_progress` - В процессе исполнения
- `partially_executed` - Частично исполнен (клиника отметила частичное исполнение)
- `executed` - Исполнен (клиника отметила полное исполнение)

## История изменений

Все действия записываются в историю договора (`ContractHistory`):

- Клиника отметила договор как исполненный (тип, примечания)
- Работодатель подтвердил исполнение
- Работодатель отклонил исполнение (причина)

## Миграции

Создана миграция `0007_add_two_step_execution.py` которая добавляет новые поля в модель Contract.

## Преимущества нового процесса

1. **Прозрачность** - работодатель видит когда клиника завершила работы
2. **Контроль качества** - работодатель может проверить результаты перед подтверждением
3. **Обратная связь** - при отклонении работодатель указывает причину
4. **История** - все действия фиксируются в истории договора
5. **Гибкость** - поддержка частичного исполнения для поэтапных работ

## Примеры использования

### Сценарий 1: Успешное исполнение

1. Клиника завершает все медосмотры
2. Клиника отмечает "Полное исполнение" с примечанием "Обследовано 100 сотрудников"
3. Работодатель проверяет результаты
4. Работодатель подтверждает исполнение
5. Договор завершен

### Сценарий 2: Частичное исполнение

1. Клиника завершает первую партию медосмотров (50 из 100)
2. Клиника отмечает "Частичное исполнение" с примечанием "Обследовано 50 сотрудников, остальные в процессе"
3. Работодатель подтверждает частичное исполнение
4. Клиника продолжает работу
5. После завершения всех работ клиника отмечает "Полное исполнение"
6. Работодатель подтверждает

### Сценарий 3: Отклонение исполнения

1. Клиника отмечает "Полное исполнение"
2. Работодатель проверяет и находит недостатки
3. Работодатель отклоняет с причиной "10 сотрудников не прошли полное обследование"
4. Договор возвращается в статус "В процессе исполнения"
5. Клиника дообследует сотрудников
6. Клиника снова отмечает исполнение
7. Работодатель подтверждает
