# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ Nginx Proxy Manager

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ blue-green deployment –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –º–µ–Ω—è—Ç—å –ø–æ—Ä—Ç—ã –≤ Nginx Proxy Manager:
- Backend API: 8001 ‚Üî 8002
- Frontend: 3001 ‚Üî 3002

–≠—Ç–æ –Ω–µ—É–¥–æ–±–Ω–æ –∏ —Ç—Ä–µ–±—É–µ—Ç –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫—É NPM.

## –†–µ—à–µ–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ NPM API!

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –í–∫–ª—é—á–∏—Ç–µ API –≤ Nginx Proxy Manager

NPM API –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –ø–æ—Ä—Ç—É 81.

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ credentials –≤ .env.prod

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env.prod` –∏ —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ NPM:

```bash
# Nginx Proxy Manager API
NPM_HOST=http://localhost:81
NPM_EMAIL=–≤–∞—à-email@npm.com
NPM_PASSWORD=–≤–∞—à-—Ä–µ–∞–ª—å–Ω—ã–π-–ø–∞—Ä–æ–ª—å
```

**–í–∞–∂–Ω–æ:** –ó–∞–º–µ–Ω–∏—Ç–µ `admin@example.com` –∏ `changeme` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!

### 3. –ì–æ—Ç–æ–≤–æ!

–°–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑—è—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ `.env.prod`.  
–ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è!

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ

**Linux/Mac:**
```bash
# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ green (8002/3002)
bash scripts/npm-switch.sh 8002 3002

# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ blue (8001/3001)
bash scripts/npm-switch.sh 8001 3001
```

**Windows PowerShell:**
```powershell
# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ green
.\scripts\npm-switch.ps1 8002 3002

# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ blue
.\scripts\npm-switch.ps1 8001 3001
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–µ–ø–ª–æ–µ–º

–°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:

```bash
# –í deploy-blue-green.sh –¥–æ–±–∞–≤—å—Ç–µ:
if [ -f ".env.npm.local" ]; then
    export $(grep -v '^#' .env.npm.local | xargs)
    bash scripts/npm-switch.sh $BACKEND_PORT $FRONTEND_PORT
fi
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

–°–∫—Ä–∏–ø—Ç –ø–æ–ª—É—á–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ NPM API:
```bash
POST /api/tokens
{
  "identity": "admin@example.com",
  "secret": "password"
}
```

### 2. –ü–æ–∏—Å–∫ Proxy Hosts

–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö proxy hosts:
```bash
GET /api/nginx/proxy-hosts
Authorization: Bearer <token>
```

–ò—â–µ—Ç hosts —Å –¥–æ–º–µ–Ω–æ–º `crm.archeo.kz`:
- –ï—Å–ª–∏ –µ—Å—Ç—å location `/api` ‚Üí Backend
- –ò–Ω–∞—á–µ ‚Üí Frontend

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤

–û–±–Ω–æ–≤–ª—è–µ—Ç `forward_port` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ host:
```bash
PUT /api/nginx/proxy-hosts/{id}
Authorization: Bearer <token>
{
  ...
  "forward_port": 8002
  ...
}
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### Linux/Mac:
- `curl` (–æ–±—ã—á–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
- `jq` –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ jq:
```bash
# Ubuntu/Debian
sudo apt-get install jq

# Mac
brew install jq
```

### Windows:
- PowerShell 5.1+ (–≤—Å—Ç—Ä–æ–µ–Ω –≤ Windows 10/11)
- –ò–ª–∏ `curl` + `jq` –¥–ª—è bat –≤–µ—Ä—Å–∏–∏

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –ø–∞—Ä–æ–ª–∏!

`.env.prod` —É–∂–µ –≤ `.gitignore`, –Ω–æ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:
1. –ù–µ –∫–æ–º–º–∏—Ç–∏—Ç–µ `.env.prod` —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–æ–ª—è–º–∏
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è dev –∏ prod
3. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–æ–∑–¥–∞–π—Ç–µ `.env.prod` —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

### –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
export NPM_HOST=http://localhost:81
export NPM_EMAIL=admin@example.com
export NPM_PASSWORD=secure-password

# –¢–µ–ø–µ—Ä—å —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è
bash scripts/npm-switch.sh 8002 3002
```

### –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ API

–í NPM —Å–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è API —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏.

## Troubleshooting

### –û—à–∏–±–∫–∞: "–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env.npm.local`
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ –≤ NPM –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —ç—Ç–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ NPM –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ö–æ—Å—Ç–µ

### –û—à–∏–±–∫–∞: "Proxy host –Ω–µ –Ω–∞–π–¥–µ–Ω"

**–ü—Ä–∏—á–∏–Ω–∞:** –°–∫—Ä–∏–ø—Ç –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–µ proxy hosts

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –¥–æ–º–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç `crm.archeo.kz`
2. –î–ª—è backend —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –µ—Å—Ç—å location `/api`
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ hosts:
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:81/api/nginx/proxy-hosts | jq
```

### –û—à–∏–±–∫–∞: "jq not found"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω jq

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# Ubuntu/Debian
sudo apt-get install jq

# Mac
brew install jq

# Windows - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PowerShell –≤–µ—Ä—Å–∏—é
```

### NPM API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–ü—Ä–∏—á–∏–Ω–∞:** NPM –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–æ—Ä—Ç –∑–∞–∫—Ä—ã—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ NPM –∑–∞–ø—É—â–µ–Ω: `docker ps | grep nginx-proxy-manager`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç: `curl http://localhost:81/api/schema`
3. –ï—Å–ª–∏ NPM –Ω–∞ –¥—Ä—É–≥–æ–º —Ö–æ—Å—Ç–µ, –æ–±–Ω–æ–≤–∏—Ç–µ `NPM_HOST`

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

### 1. –†—É—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ (—Ç–µ–∫—É—â–∏–π —Å–ø–æ—Å–æ–±)

–ó–∞—Ö–æ–¥–∏—Ç–µ –≤ NPM –∞–¥–º–∏–Ω–∫—É –∏ –º–µ–Ω—è–µ—Ç–µ –ø–æ—Ä—Ç—ã –≤—Ä—É—á–Ω—É—é.

**–ü–ª—é—Å—ã:**
- –ü—Ä–æ—Å—Ç–æ—Ç–∞
- –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ
- –ú–æ–∂–Ω–æ –æ—à–∏–±–∏—Ç—å—Å—è

### 2. API –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ (—ç—Ç–æ—Ç —Å–ø–æ—Å–æ–±)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç.

**–ü–ª—é—Å—ã:**
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
- –ë—ã—Å—Ç—Ä–µ–µ
- –ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –ù—É–∂–Ω—ã credentials

### 3. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Nginx (–±–µ–∑ NPM)

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π Nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–º–µ—Å—Ç–æ NPM.

**–ü–ª—é—Å—ã:**
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- –ú–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥–∏

**–ú–∏–Ω—É—Å—ã:**
- –°–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- –ù—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- –¢–µ—Ä—è–µ—Ç–µ —É–¥–æ–±–Ω—ã–π UI NPM

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–ª—è production:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ API –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
2. **–î–ª—è testing:** –ú–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é
3. **–•—Ä–∞–Ω–∏—Ç–µ credentials –±–µ–∑–æ–ø–∞—Å–Ω–æ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ:** –°–Ω–∞—á–∞–ª–∞ –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏

## –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º

```bash
#!/bin/bash

# 1. –î–µ–ø–ª–æ–∏–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
make bg-deploy

# 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º
curl http://localhost:8002/api/health/
curl http://localhost:3002/

# 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º NPM (—á–∏—Ç–∞–µ—Ç –∏–∑ .env.prod)
bash scripts/npm-switch.sh 8002 3002

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º production
curl https://crm.archeo.kz/api/health/

# 5. –ï—Å–ª–∏ OK - –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
make bg-cleanup
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç NPM credentials –∏–∑ `.env.prod`!

## –ò—Ç–æ–≥

‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è NPM  
‚úÖ –≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏  
‚úÖ –ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫  
‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π  

üöÄ **Zero-downtime deployment —Å—Ç–∞–ª –µ—â–µ –ø—Ä–æ—â–µ!**
