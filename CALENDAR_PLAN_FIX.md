# Исправления календарного плана

## Что исправлено:

### 1. Сортировка календарных планов
- ✅ Последний созданный план теперь всегда отображается сверху
- Сортировка по дате создания (от новых к старым)

### 2. Генерация PDF
- ✅ Улучшена обработка ошибок при генерации PDF
- ✅ Добавлена поддержка русских символов в именах файлов
- ✅ Добавлено детальное логирование для отладки
- ✅ Исправлена обработка поля `departments_info` (поддержка camelCase и snake_case)

### 3. Обработка ошибок
- ✅ Детальные сообщения об ошибках в консоли браузера
- ✅ Логирование на backend для отладки
- ✅ Улучшенная обработка различных форматов ошибок от API

## Как проверить:

### 1. Проверка сортировки:
1. Откройте страницу "Календарный план" в клинике
2. Создайте несколько календарных планов
3. Убедитесь, что последний созданный план отображается сверху списка

### 2. Проверка генерации PDF:
1. Откройте страницу "Календарный план"
2. Нажмите кнопку "Генерировать PDF" на любом плане
3. Откройте консоль браузера (F12) для просмотра логов
4. Проверьте:
   - PDF файл должен скачаться автоматически
   - В консоли должны быть логи: `[PDF] Generating PDF for plan...`
   - Если есть ошибка, она будет показана с деталями

### 3. Просмотр логов backend:
```bash
docker-compose logs backend --tail=50 --follow
```

Ищите строки с префиксом `[PDF Export]` для отладки генерации PDF.

## Если возникает ошибка при генерации PDF:

1. **Откройте консоль браузера (F12)** - там будут детали ошибки
2. **Проверьте логи backend**:
   ```bash
   docker-compose logs backend --tail=100 | findstr "PDF"
   ```
3. **Проверьте, что ReportLab установлен**:
   ```bash
   docker-compose exec backend pip list | findstr reportlab
   ```

## Типичные ошибки и решения:

### Ошибка: "ReportLab library not installed"
**Решение:**
```bash
docker-compose exec backend pip install reportlab
docker-compose restart backend
```

### Ошибка: "Получен пустой PDF файл"
**Причина:** Ошибка при генерации PDF на backend
**Решение:** Проверьте логи backend для деталей

### Ошибка: "KeyError: 'startDate'" или подобные
**Причина:** Несоответствие формата данных
**Решение:** Уже исправлено - код теперь поддерживает оба формата (camelCase и snake_case)

## Дополнительная информация:

- Календарные планы сортируются по полю `created_at` в порядке убывания
- PDF генерируется с использованием библиотеки ReportLab
- Имена файлов PDF безопасны для всех операционных систем
- Поддержка русских символов в именах файлов через UTF-8 encoding
